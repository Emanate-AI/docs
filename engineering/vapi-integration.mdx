---
title: "VAPI Integration"
description: "4-layer VAPI architecture for voice and chat AI"
---

# VAPI Integration Architecture

Emanate integrates with VAPI (Voice AI Platform) using a clean 4-layer architecture that separates concerns and provides type safety, caching, and a clean developer experience.

## Why VAPI?

VAPI provides:
- Voice AI with natural conversation
- Real-time transcription
- Multiple LLM providers
- Phone number management
- Chat capabilities

## Architecture Layers

```
┌─────────────────────────────────────────────────────────────────┐
│  Layer 4: React Hooks (Client)                                   │
│  └── useAssistants, useCreateAssistant, useUpdateAssistant       │
├─────────────────────────────────────────────────────────────────┤
│  Layer 3: Server Actions (Next.js "use server")                  │
│  └── createAssistantAction, updateAssistantAction, etc.          │
├─────────────────────────────────────────────────────────────────┤
│  Layer 2: Service Layer (Business Logic)                         │
│  └── AssistantService, ToolService, PhoneNumberService           │
├─────────────────────────────────────────────────────────────────┤
│  Layer 1: VAPI Client Library (SDK Wrapper)                      │
│  └── VapiClient class, types, config                             │
└─────────────────────────────────────────────────────────────────┘
```

## Layer 1: VAPI Client

The lowest-level wrapper around the official `@vapi-ai/server-sdk`:

```typescript
import { vapi } from "@/lib/vapi";

// Use singleton (recommended)
const assistant = await vapi.getAssistant(id);
const calls = await vapi.listCalls({ limit: 50 });
```

### Features

- **Automatic Retries**: Exponential backoff for transient errors
- **Configurable Timeouts**: Default 60 seconds
- **Type Safety**: Full TypeScript support

### Supported Resources

| Resource | Operations |
|----------|------------|
| Assistants | CRUD |
| Calls | List, Get |
| Chats | List, Get |
| Phone Numbers | CRUD |
| Squads | CRUD |
| Tools | CRUD |
| Files | Upload, List |
| Campaigns | CRUD |

## Layer 2: Service Layer

Business logic and orchestration:

```typescript
import { AssistantService } from "@/features/agents/services";

const service = new AssistantService();

// Creates in VAPI, syncs to Supabase
const result = await service.createAssistant(data, orgId);

// Reads from Supabase cache (fast!)
const assistants = await service.listAssistants(orgId, "voice");
```

### Key Pattern: VAPI Writes, Supabase Reads

```
┌─────────────────┐     ┌─────────────────┐
│     VAPI API    │     │    Supabase     │
│  (Write Source) │     │   (Read Cache)  │
└────────┬────────┘     └────────┬────────┘
         │                       │
         │  Create/Update/Delete │  List/Get (fast)
         │         │             │         │
         └─────────┴─────────────┴─────────┘
                         │
              ┌──────────┴──────────┐
              │   Service Layer     │
              │  (Orchestration)    │
              └─────────────────────┘
```

### Benefits

- **Fast Reads**: List views load instantly from cache
- **Consistent Writes**: All mutations through VAPI
- **Automatic Sync**: Services sync after writes

## Layer 3: Server Actions

Next.js Server Actions bridge client and services:

```typescript
"use server";

export async function createAssistantAction(
  data: CreateAssistantRequest,
  accessToken: string
) {
  // 1. Authenticate
  const orgId = await getOrgIdFromToken(accessToken);
  
  // 2. Delegate to service
  const service = new AssistantService();
  const result = await service.createAssistant(data, orgId);
  
  // 3. Invalidate cache
  if (result.success) {
    revalidatePath("/voice-agents");
  }
  
  return result;
}
```

### Responsibilities

| Task | Description |
|------|-------------|
| Authentication | Extract orgId from token |
| Authorization | Verify access rights |
| Delegation | Call service methods |
| Cache Invalidation | Trigger revalidatePath |
| Error Handling | Format errors for client |

## Layer 4: React Hooks

Client-side hooks for UI components:

```typescript
import { useAssistants, useCreateAssistant } from "@/features/agents/hooks";

function VoiceAgentsPage() {
  // Read from cache
  const { assistants, isLoading, refresh } = useAssistants({
    agentType: "voice",
  });
  
  // Mutation hook
  const { create, isPending } = useCreateAssistant();
  
  const handleCreate = async (data) => {
    const result = await create(data);
    if (result.success) refresh();
  };
}
```

### Features

- **Request Deduplication**: Prevents parallel duplicate calls
- **Silent Refresh**: Background updates without loading spinners
- **Auth Integration**: Automatic token handling

## Data Flow: Creating an Assistant

```
┌────────────────────────────────────────────────────────────────┐
│ 1. UI: Button Click                                            │
│    └── Calls useCreateAssistant().create(data)                 │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│ 2. Hook: Calls Server Action                                    │
│    └── createAssistantAction(data, accessToken)                │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│ 3. Server Action                                                │
│    ├── Validates access token                                   │
│    ├── Extracts orgId                                           │
│    └── Calls AssistantService.createAssistant()                │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│ 4. Service                                                      │
│    ├── Builds system prompt                                     │
│    ├── Calls vapi.createAssistant()                            │
│    ├── Syncs to Supabase                                       │
│    └── Creates structured outputs                               │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│ 5. Response Flows Back                                          │
│    ├── Service returns { success: true, data }                 │
│    ├── Action calls revalidatePath()                           │
│    └── Hook updates state, UI re-renders                       │
└────────────────────────────────────────────────────────────────┘
```

## Best Practices

### Use the Singleton

```typescript
// ✅ Good
import { vapi } from "@/lib/vapi";
const assistant = await vapi.getAssistant(id);

// ❌ Avoid
const client = new VapiClient();
```

### Go Through Services

```typescript
// ✅ Good - handles cleanup, caching
const service = new AssistantService();
await service.deleteAssistant(id);

// ❌ Avoid - bypasses cleanup
await vapi.deleteAssistant(id);
```

### Use Hooks in Components

```typescript
// ✅ Good
const { assistants } = useAssistants();

// ❌ Avoid
useEffect(() => {
  listAssistantsAction(token).then(setAssistants);
}, []);
```

## Next Steps

<CardGroup cols={2}>
  <Card title="Data Flow" icon="arrows-rotate" href="/engineering/data-flow">
    Detailed data patterns
  </Card>
  <Card title="Architecture" icon="sitemap" href="/engineering/architecture">
    System overview
  </Card>
</CardGroup>
